use master

create Database quanLiKaraokeNice
USE quanLiKaraokeNice

USE MASTER
DROP DATABASE quanLiKaraokeNice

CREATE TABLE NHANVIEN(
	MANV NVARCHAR(50) NOT NULL,
	TENNV NVARCHAR(50),
	TAIKHOAN NVARCHAR(50),
	MATKHAU NVARCHAR(50),
	CMND VARCHAR(10) NOT NULL UNIQUE,
	SDT VARCHAR(12) NOT NULL,
	GIOITINH NVARCHAR(3) CHECK (GIOITINH IN (N'Nam', N'Nữ')),
	DIACHI NVARCHAR(200),
	CHUCVU NVARCHAR(4) CHECK (CHUCVU IN ('QL','NV')),
	CONSTRAINT PK_NHANVIEN PRIMARY KEY (MANV)
)

CREATE TABLE KHACHHANG(
	MAKH NVARCHAR(50) NOT NULL,
	TENKH NVARCHAR(50),
	SDT VARCHAR(12) NOT NULL UNIQUE,
	DIACHI NVARCHAR(200),
	CONSTRAINT PK_KHACHHANG PRIMARY KEY (MAKH)
)

CREATE TABLE LOAIPHONG(
	MALOAIPHONG NVARCHAR(50) NOT NULL,
	TENLOAIPHONG NVARCHAR(50) NOT NULL,
	CONSTRAINT PK_LOAIPHONG PRIMARY KEY (MALOAIPHONG)
)
CREATE TABLE PHONG(
	MAPHONG NVARCHAR(50) NOT NULL,
	TENPHONG NVARCHAR(50),
	TRANGTHAI NVARCHAR(50) CHECK(TRANGTHAI IN(N'ĐANG SỬ DỤNG',N'TRỐNG',N'CHỜ',N'CHỜ(Sử dung)')),
	SUCCHUA INT CHECK(SUCCHUA >0),
	MALOAIPHONG NVARCHAR(50),
	DONGIA INT CHECK(DONGIA >=0) NOT NULL,
	CONSTRAINT PK_PHONG PRIMARY KEY (MAPHONG)
)
CREATE TABLE DICHVU(
	MADV NVARCHAR(50) NOT NULL,
	TENDV NVARCHAR(50),
	DONGIA INT CHECK(DONGIA >=0) NOT NULL,
	DONVI NVARCHAR(20),
	SOLUONGTONKHO INT CHECK(SOLUONGTONKHO >=0),
	CONSTRAINT PK_DICHVU PRIMARY KEY (MADV)
)

CREATE TABLE HOADON (
	MAHOADON NVARCHAR(50) NOT NULL,
	THOIGIANBD DATETIME,
	THOIGIANKT DATETIME,
	NGAYTAO DATETIME,
	MANV NVARCHAR(50),
	MAKH NVARCHAR(50),
	CONSTRAINT PK_HOADON PRIMARY KEY (MAHOADON)
)

CREATE TABLE CHITIETDICHVU (
	MADV NVARCHAR(50) NOT NULL,
	MAHOADON NVARCHAR(50)NOT NULL,
	SOLUONG INT CHECK (SOLUONG >=0),
	CONSTRAINT PK_CHITIETDV PRIMARY KEY(MADV,MAHOADON)
)
CREATE TABLE CHITIETHOADON (
	MAHOADON NVARCHAR(50),
	MAPHONG NVARCHAR(50),
	THOILUONG INT CHECK (THOILUONG >=0),
	CONSTRAINT PK_CHITIETHOADON PRIMARY KEY (MAHOADON,MAPHONG)
)

CREATE TABLE PHIEUDAT(
	MAPHIEUDAT NVARCHAR(50) NOT NULL,
	MAKH NVARCHAR(50),
	MANV NVARCHAR(50),
	NGAYDAT DATETIME,
	TRANGTHAI BIT,
	CONSTRAINT PK_PHIEUDAT PRIMARY KEY (MAPHIEUDAT)
)

CREATE TABLE CHITIETPHIEUDATPHONG(
	MAPHIEUDAT NVARCHAR(50) NOT NULL,
	MAPHONG NVARCHAR(50) NOT NULL,
	CONSTRAINT PK_CTPDPHONG PRIMARY KEY (MAPHIEUDAT,MAPHONG)
)
CREATE TABLE CHITIETPHIEUDATDICHVU(
	MAPHIEUDAT NVARCHAR(50) NOT NULL,
	MADV NVARCHAR(50) NOT NULL,
	SOLUONG INT CHECK (SOLUONG >=0),
	CONSTRAINT PK_CTPDDICHVU PRIMARY KEY (MAPHIEUDAT,MADV)
)

CREATE TABLE [dbo].[TrangThaiPhong](
	[maTTP] [varchar](6) NOT NULL,
	[tenTrangThaiPhong] [nvarchar](max) NULL
	)
INSERT [dbo].[TrangThaiPhong] ([maTTP], [tenTrangThaiPhong]) VALUES (N'TTP001', N'ĐANG SỬ DỤNG')
INSERT [dbo].[TrangThaiPhong] ([maTTP], [tenTrangThaiPhong]) VALUES (N'TTP002', N'CHỜ')
INSERT [dbo].[TrangThaiPhong] ([maTTP], [tenTrangThaiPhong]) VALUES (N'TTP003', N'TRỐNG')
INSERT [dbo].[TrangThaiPhong] ([maTTP], [tenTrangThaiPhong]) VALUES (N'TTP004', N'CHỜ(Sử dung)')

ALTER TABLE PHONG ADD CONSTRAINT FK_PHONG_LOAIPHONG FOREIGN KEY (MALOAIPHONG) REFERENCES LOAIPHONG(MALOAIPHONG)
ALTER TABLE HOADON ADD CONSTRAINT FK_HOADON_NHANVIEN FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
ALTER TABLE HOADON ADD CONSTRAINT FK_HOADON_KHACHHANG FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)

ALTER TABLE CHITIETDICHVU ADD CONSTRAINT FK_CTDV_DICHVU FOREIGN KEY (MADV) REFERENCES DICHVU (MADV)
ALTER TABLE CHITIETDICHVU ADD CONSTRAINT FK_CTDV_HOADON FOREIGN KEY (MAHOADON) REFERENCES HOADON(MAHOADON)

ALTER TABLE CHITIETHOADON ADD CONSTRAINT FK_CTHOADON_PHONG FOREIGN KEY (MAPHONG) REFERENCES PHONG(MAPHONG)
ALTER TABLE CHITIETHOADON ADD CONSTRAINT FK_CHITIETHOADON_HOADON FOREIGN KEY (MAHOADON) REFERENCES HOADON (MAHOADON)

ALTER TABLE CHITIETPHIEUDATDICHVU ADD CONSTRAINT FK_CTPDDICHVU_DICHVU FOREIGN KEY (MADV) REFERENCES DICHVU (MADV)
ALTER TABLE CHITIETPHIEUDATDICHVU ADD CONSTRAINT FK_CTPDDICHVU_PHIEUDAT FOREIGN KEY (MAPHIEUDAT) REFERENCES PHIEUDAT (MAPHIEUDAT)

ALTER TABLE CHITIETPHIEUDATPHONG ADD CONSTRAINT FK_CTPDPHONG_PHONG FOREIGN KEY (MAPHONG) REFERENCES PHONG (MAPHONG)
ALTER TABLE CHITIETPHIEUDATPHONG ADD CONSTRAINT FK_CTPDPHONG_PHIEUDAT FOREIGN KEY (MAPHIEUDAT) REFERENCES  PHIEUDAT (MAPHIEUDAT)

ALTER TABLE PHIEUDAT ADD CONSTRAINT FK_PHIEUDAT_NV FOREIGN KEY (MANV) REFERENCES NHANVIEN (MANV)
ALTER TABLE PHIEUDAT ADD CONSTRAINT FK_PHIEUDAT_KH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)



INSERT [dbo].[NHANVIEN] ([MANV], [TENNV], [TAIKHOAN], [MATKHAU], [CMND], [SDT],[GIOITINH],[DIACHI],[CHUCVU]) VALUES ('NV001',N'Phan Đình Thái','phandinhthai','12345678','0642031683','0866952340',N'Nam',N'Phường 5 gò vâp HCM','QL')
INSERT [dbo].[NHANVIEN] ([MANV], [TENNV], [TAIKHOAN], [MATKHAU], [CMND], [SDT],[GIOITINH],[DIACHI],[CHUCVU]) VALUES ('NV002',N'Cao Minh Trí','caominhtri','12345678','0135168568','0123456789',N'Nam',N' gò vâp HCM','QL')


--select *from PHONG
--select * from PHIEUDAT
--select * from CHITIETPHIEUDATPHONG
----select * from CHITIETPHIEUDATDICHVU
--select * from HOADON
--select * from CHITIETHOADON
--select * from CHITIETDICHVU
--select * from CHITIETPHIEUDATPHONG as ct join PHIEUDAT as pd on ct.MAPHIEUDAT= pd.MAPHIEUDAT
--select * from CHITIETPHIEUDATPHONG as ct join PHONG as p on ct.MAPHONG = p.MALOAIPHONG join PHIEUDAT as pd on  ct.MAPHIEUDAT = pd.MAPHIEUDAT

INSERT [dbo].[LOAIPHONG] ([MALOAIPHONG],[TENLOAIPHONG]) VALUES (N'LP01',N'Phòng VIP')
INSERT [dbo].[LOAIPHONG] ([MALOAIPHONG],[TENLOAIPHONG]) VALUES (N'LP02',N'Phòng Thường')
INSERT [dbo].[Phong] ([maPhong], [TENPHONG], [TRANGTHAI], [MALOAIPHONG], [SUCCHUA],[DONGIA]) VALUES (N'P001',N'Phòng 001',N'TRỐNG',N'LP01',15,200000)
INSERT [dbo].[Phong] ([maPhong], [TENPHONG], [TRANGTHAI], [MALOAIPHONG], [SUCCHUA],[DONGIA]) VALUES (N'P002',N'Phòng 002',N'TRỐNG',N'LP01',10,200000)
INSERT [dbo].[Phong] ([maPhong], [TENPHONG], [TRANGTHAI], [MALOAIPHONG], [SUCCHUA],[DONGIA]) VALUES (N'P003',N'Phòng 003',N'TRỐNG',N'LP02',20,100000)
INSERT [dbo].[Phong] ([maPhong], [TENPHONG], [TRANGTHAI], [MALOAIPHONG], [SUCCHUA],[DONGIA]) VALUES (N'P004',N'Phòng 004',N'TRỐNG',N'LP02',15,100000)
INSERT [dbo].[Phong] ([maPhong], [TENPHONG], [TRANGTHAI], [MALOAIPHONG], [SUCCHUA],[DONGIA]) VALUES (N'P005',N'Phòng 005',N'TRỐNG',N'LP01',10,200000)
INSERT [dbo].[Phong] ([maPhong], [TENPHONG], [TRANGTHAI], [MALOAIPHONG], [SUCCHUA],[DONGIA]) VALUES (N'P006',N'Phòng 006',N'TRỐNG',N'LP02',20,100000)
INSERT [dbo].[Phong] ([maPhong], [TENPHONG], [TRANGTHAI], [MALOAIPHONG], [SUCCHUA],[DONGIA]) VALUES (N'P007',N'Phòng 007',N'TRỐNG',N'LP02',20,100000)
INSERT [dbo].[Phong] ([maPhong], [TENPHONG], [TRANGTHAI], [MALOAIPHONG], [SUCCHUA],[DONGIA]) VALUES (N'P008',N'Phòng 008',N'TRỐNG',N'LP02',20,100000)
INSERT [dbo].[Phong] ([maPhong], [TENPHONG], [TRANGTHAI], [MALOAIPHONG], [SUCCHUA],[DONGIA]) VALUES (N'P009',N'Phòng 009',N'TRỐNG',N'LP02',20,100000)
INSERT [dbo].[Phong] ([maPhong], [TENPHONG], [TRANGTHAI], [MALOAIPHONG], [SUCCHUA],[DONGIA]) VALUES (N'P010',N'Phòng 010',N'TRỐNG',N'LP02',20,100000)
INSERT [dbo].[Phong] ([maPhong], [TENPHONG], [TRANGTHAI], [MALOAIPHONG], [SUCCHUA],[DONGIA]) VALUES (N'P011',N'Phòng 011',N'TRỐNG',N'LP02',20,100000)

INSERT [dbo].[DichVu] ([maDV], [donGia], [donVi], [SOLUONGTONKHO], [TENDV]) VALUES (N'DV004', 20000, N'Lon', 93, N'Bia')
INSERT [dbo].[DichVu] ([maDV], [donGia], [donVi], [SOLUONGTONKHO], [TENDV]) VALUES (N'DV002', 150000, N'Đĩa', 66, N'Trái cây')
INSERT [dbo].[DichVu] ([maDV], [donGia], [donVi], [SOLUONGTONKHO], [TENDV]) VALUES (N'DV003', 20000, N'Lon', 75, N'Nước ngọt')
INSERT [dbo].[DichVu] ([maDV], [donGia], [donVi], [SOLUONGTONKHO], [TENDV]) VALUES (N'DV004', 50000, N'Lon', 75, N'Bia')
INSERT [dbo].[DichVu] ([maDV], [donGia], [donVi], [SOLUONGTONKHO], [TENDV]) VALUES (N'DV005', 200000, N'Phần', 69, N'Trang trí phòng')
INSERT [dbo].[DichVu] ([maDV], [donGia], [donVi], [SOLUONGTONKHO], [TENDV]) VALUES (N'DV006', 300000, N'Phần', 38, N'Bánh kem')
INSERT [dbo].[DichVu] ([maDV], [donGia], [donVi], [SOLUONGTONKHO], [TENDV]) VALUES (N'DV007', 30000, N'Lon', 49, N'Bia Tiger')

----insert into CHITIETPHIEUDATDICHVU ([MAPHIEUDAT],[MADV],[SOLUONG]) values('PD0005','DV004',5)
--update PHIEUDAT set TRANGTHAI=0 where MAPHIEUDAT ='PD0006'

----SELECT DATEPART(HOUR, THOIGIANBD) AS gio, COUNT(*) AS soLuong from HOADON GROUP BY DATEPART(HOUR, THOIGIANBD) ORDER BY soLuong DESC

----select * from HOADON where datepart(hour,THOIGIANBD)=2
--select COUNT(*) as soluong from HOADON where datepart(hour,THOIGIANBD)=2

--select  COUNT(*) as soluong from HOADON where DAY(NGAYTAO) =24 and MONTH(NGAYTAO) =11 AND YEAR(NGAYTAO) = 2023AND datepart(hour,THOIGIANBD)=5
--select * from PHIEUDAT where TRANGTHAI like '%%'


CREATE TABLE PHIEUDATPHONGCHO(
	MAPHIEUDATPHONGCHO NVARCHAR(50) NOT NULL,
	MAKH NVARCHAR(50),
	MANV NVARCHAR(50),
	NGAYDANGKI DATETIME,
	NGAYNHANPHONG DATETIME,
	TRANGTHAI BIT,
	CONSTRAINT PK_PHIEUDATPHONGCHO PRIMARY KEY (MAPHIEUDATPHONGCHO)
)

CREATE TABLE CTPHIEUDATPHONGCHO(
	MAPHIEUDATPHONGCHO NVARCHAR(50) NOT NULL,
	MAPHONG NVARCHAR(50) NOT NULL,
	CONSTRAINT PK_CTPDPHONGCHO PRIMARY KEY (MAPHIEUDATPHONGCHO,MAPHONG)
)


ALTER TABLE PHIEUDATPHONGCHO ADD CONSTRAINT FK_PDPHONGCHO_KHACHHANG FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)
ALTER TABLE PHIEUDATPHONGCHO ADD CONSTRAINT FK_PDPHONGCHO_NHANVIEN FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)

ALTER TABLE CTPHIEUDATPHONGCHO ADD CONSTRAINT FK_CTPDPHONGCHO_PDPHONGCHO FOREIGN KEY (MAPHIEUDATPHONGCHO) REFERENCES  PHIEUDATPHONGCHO (MAPHIEUDATPHONGCHO)
ALTER TABLE CTPHIEUDATPHONGCHO ADD CONSTRAINT FK_CTPDPHONGCHO_PHONG FOREIGN KEY (MAPHONG) REFERENCES PHONG (MAPHONG)

select * from PHIEUDATPHONGCHO
select * from PHIEUDATPHONGCHO as pd join CTPHIEUDATPHONGCHO as ct on pd.MAPHIEUDATPHONGCHO=ct.MAPHIEUDATPHONGCHO

--ALTER TABLE PHONG
--ADD CONSTRAINT TRANGTHAI
--CHECK (TRANGTHAI IN (N'ĐANG SỬ DỤNG',N'TRỐNG',N'CHỜ',N'CHỜ(Sử dung)'));


--update  PHIEUDATPHONGCHO set TRANGTHAI=0 
--DELETE FROM PHIEUDAT
--WHERE MAPHIEUDAT = 'PD0010'
--select *from CTPHIEUDATPHONGCHO
--select * from PHIEUDATPHONGCHO where TRANGTHAI = 0
--select * from PHIEUDATPHONGCHO as pd join KhachHang as kh on pd.MAKH= kh.MaKH where kh.SDT like N'%0866%' AND pd.MAPHIEUDATPHONGCHO like N'%DP%'

--select top 1 * from PHIEUDATPHONGCHO as pd join CTPHIEUDATPHONGCHO as ct on pd.MAPHIEUDATPHONGCHO = ct.MAPHIEUDATPHONGCHO where pd.TRANGTHAI = 0 and ct.MAPHONG ='P004' order by pd.MAPHIEUDATPHONGCHO DESC
--where maPhong = '" + maPhong
--					+ "' and tinhTrang = '1' order by  maPDP desc "
--update PHONG set TRANGTHAI = N'CHỜ' where MAPHONG = 'P004'


--select * from HOADON as hd join CHITIETHOADON as ct on hd.MAHOADON = ct.MAHOADON where hd.MAKH ='KH001'

--SELECT DISTINCT MAKH FROM HOADON
--select * from NhanVien where TAIKHOAN ='phandinhthai'

--select * from NhanVien where GIOITINH like N'%%'
select * from NhanVien